# --------------------------------------------------------------------------------------
# Part of the interTwin Project: https://www.intertwin.eu/
#
# Created by: Matteo Bunino
#
# Credit:
# - Matteo Bunino <matteo.bunino@cern.ch> - CERN
# --------------------------------------------------------------------------------------

name: Testing with pytest

on:
  pull_request:
    branches: [main]

jobs:
  test-torch:
    name: Testing with pytest
    runs-on: ubuntu-latest
    steps:

      # Uncomment this only if you run out of disk space!
      # - name: Maximize Disk Space
      #   uses: easimon/maximize-build-space@v10
      #   with:
      #     # Reserve space on root for docker/dagger cache
      #     build-mount-path: /docker
      #     root-reserve-mb: 2048
      #     overprovision-lvm: false
      #     swap-size-mb: 4096
      #     remove-dotnet: true
      #     remove-android: true
      #     remove-haskell: true
      #     remove-codeql: true

      - uses: actions/checkout@v4
      
      #  ALSO uncomment this only if you run out of disk space!
      # - name: Move Docker directory
      #   shell: bash
      #   run: |
      #     sudo mv /var/lib/docker /docker/ &&
      #     sudo ln -s /docker/docker /var/lib/docker &&
      #     sudo systemctl restart docker

      # Run tests with pytest in a container
      - name: Run Integration Test (development pipeline)
        uses: dagger/dagger-for-github@v7
        with:
          workdir: ci
          verb: call
          args: >-
            build-container
            --context ..
            --dockerfile ../env-files/torch/skinny.Dockerfile
            test-local
            --cmd "pytest,-v,--disable-warnings,-n,logical,/app/tests/,--dist,loadfile,-m,not hpc and not tensorflow"
            logs
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}
          version: latest

  